<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fișă de Pontaj – Cramă</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial; }

    /* Print-friendly A4 */
    @page { size: A4; margin: 14mm; }
    @media print {
      .no-print { display: none !important; }
      .print-block { display: block !important; }
      .shadow-md, .shadow { box-shadow: none !important; }
      .ring-1 { box-shadow: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      tr { page-break-inside: avoid; }
    }

    .focusable:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.6); border-radius: .5rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <a href="#content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white px-3 py-2 rounded-md shadow">Sari la conținut</a>

  <header class="bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-semibold">Fișă de Pontaj – Cramă</h1>
      <div class="text-sm text-gray-500">Versiunea 3.2</div>
    </div>
  </header>

  <main id="content" class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Panou acțiuni -->
    <section class="no-print mb-4 grid grid-cols-2 sm:flex gap-2">
      <button id="addRow" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Adaugă rând</button>
      <button id="deleteSelected" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Șterge selectatele</button>
      <button id="exportCSV" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Export CSV</button>
      <button id="printBtn" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800">Printează</button>
      <button id="resetData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600">Resetează date</button>
    </section>

    <!-- Formular + tabel -->
    <form id="timesheetForm" class="bg-white rounded-xl shadow-md ring-1 ring-gray-200 overflow-hidden">
      <div class="p-4 sm:p-6">
        <div class="max-w-sm">
          <label for="workerSelect" class="block text-sm font-medium text-gray-700">Angajat (Cramă)</label>
          <select id="workerSelect" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border">
            <option value="Prică Jenița">Prică Jenița</option>
            <option value="Neagu Marian">Neagu Marian</option>
            <option value="Banu Mitică">Banu Mitică</option>
            <option value="Prică Emilian">Prică Emilian</option>
            <option value="__custom">Alt nume…</option>
          </select>
          <input id="workerName" name="workerName" type="text"
                 class="mt-2 hidden w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border"
                 placeholder="Introdu numele" />
          <p class="mt-1 text-xs text-gray-500">Pontajul se salvează automat în acest browser, separat pentru fiecare angajat.</p>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-3 py-2 text-left font-semibold">✔</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Data</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Început</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Sfârșit</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Pauză (min)</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Activitate / Observații</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Ore</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="6" class="px-3 py-3 text-right font-semibold">Total general (ore):</td>
              <td class="px-3 py-3 text-right"><span id="grandTotal" class="font-bold">0.00</span></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="p-4 grid sm:grid-cols-2 gap-6 print-block hidden">
        <div>
          <p class="font-semibold">Întocmit de:</p>
          <div class="h-16 border-b"></div>
        </div>
        <div>
          <p class="font-semibold">Confirmat (Responsabil cramă):</p>
          <div class="h-16 border-b"></div>
        </div>
      </div>
    </form>

    <p class="mt-3 text-xs text-gray-500">Hint: Dacă o tură trece de miezul nopții, bifează „Zi următoare” pe rândul respectiv.</p>
  </main>

  <footer class="no-print border-t bg-white">
    <div class="max-w-5xl mx-auto px-4 py-3 text-xs text-gray-500">© <span id="year"></span> – Fișă de Pontaj Cramă</div>
  </footer>

  <!-- Row template -->
  <template id="rowTemplate">
    <tr>
      <td class="px-3 py-2 align-top">
        <input type="checkbox" aria-label="Selectează rând" class="focusable w-4 h-4" />
      </td>

      <td class="px-3 py-2 align-top">
        <label class="sr-only">Data</label>
        <input type="date" class="focusable mt-1 block w-40 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-2 py-1 border" />
      </td>

      <td class="px-3 py-2 align-top">
        <label class="sr-only">Început</label>
        <input type="time" step="60" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-2 py-1 border" />
      </td>

      <td class="px-3 py-2 align-top">
        <label class="sr-only">Sfârșit</label>
        <div class="flex items-center gap-2">
          <input type="time" step="60" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-2 py-1 border" />
          <label class="inline-flex items-center gap-1 text-xs text-gray-600 select-none">
            <input type="checkbox" class="next-day-toggle">
            <span>Zi următoare</span>
          </label>
        </div>
      </td>

      <td class="px-3 py-2 align-top">
        <label class="sr-only">Pauză (minute)</label>
        <input type="number" min="0" step="5" value="0" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-2 py-1 border" />
      </td>

      <td class="px-3 py-2 align-top">
        <label class="sr-only">Activitate</label>
        <textarea rows="1" class="focusable mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-2 py-1 border" placeholder="ex: cules, sortare, transport…"></textarea>
      </td>

      <td class="px-3 py-2 align-top text-right">
        <output class="rowTotal font-medium">0.00</output>
      </td>
    </tr>
  </template>

  <script>
    // ---------- Helpers & state ----------
    const WORKERS = ["Prică Jenița","Neagu Marian","Banu Mitică","Prică Emilian"];
    const els = {
      tableBody: document.getElementById("tableBody"),
      rowTmpl: document.getElementById("rowTemplate"),
      grandTotal: document.getElementById("grandTotal"),
      addRow: document.getElementById("addRow"),
      deleteSelected: document.getElementById("deleteSelected"),
      exportCSV: document.getElementById("exportCSV"),
      printBtn: document.getElementById("printBtn"),
      resetData: document.getElementById("resetData"),
      workerSelect: document.getElementById("workerSelect"),
      workerName: document.getElementById("workerName"),
      year: document.getElementById("year"),
    };
    els.year.textContent = new Date().getFullYear();

    const slug = s => (s||"")
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    const currentWorker = () =>
      els.workerSelect.value === "__custom"
        ? (els.workerName.value.trim() || "custom")
        : els.workerSelect.value;

    const storageKey = () => `pontaj-v3-${slug(currentWorker())}`;
    let saveTimeout = null;

    // ---------- Core ----------
    function computeDuration(start, end, breakMin, isNextDay=false) {
      if (!start || !end) return 0;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let startM = sh*60 + sm;
      let endM   = eh*60 + em;
      if (isNextDay || endM < startM) endM += 24*60;  // handle crossing midnight
      const diff = Math.max(0, endM - startM - (parseInt(breakMin||0,10)));
      return diff/60;
    }

    function computeGrand() {
      let total = 0;
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        total += parseFloat(tr.querySelector("output.rowTotal").textContent || "0");
      });
      els.grandTotal.textContent = total.toFixed(2);
    }

    function debouncedSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(save, 700);
    }

    function save() {
      const rows = [];
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const [chk, date, start, end, breakMin, notes, out] = tr.querySelectorAll("input, textarea, output");
        const nextDay = tr.querySelector('input.next-day-toggle');
        rows.push({
          date: date.value || "",
          start: start.value || "",
          end: end.value || "",
          nextDay: !!(nextDay && nextDay.checked),
          breakMin: parseInt(breakMin.value || 0, 10),
          notes: notes.value || "",
          hours: parseFloat(out.textContent || "0"),
        });
      });
      const payload = { meta: { worker: currentWorker(), lastUpdated: new Date().toISOString(), version: "3.2" }, rows };
      localStorage.setItem(storageKey(), JSON.stringify(payload));
    }

    function load() {
      els.tableBody.innerHTML = "";
      const raw = localStorage.getItem(storageKey());
      let data = null;
      try { data = raw ? JSON.parse(raw) : null; } catch {}
      const list = (data && data.rows && data.rows.length) ? data.rows : [{}];
      list.forEach(r => addRow(r));
      computeGrand();
    }

    // ---------- UI ----------
    function addRow(data) {
      const node = els.rowTmpl.content.cloneNode(true);
      const [chk, date, start, end, breakMin, notes, out] = node.querySelectorAll("input, textarea, output");
      const nextDay = node.querySelector("input.next-day-toggle");

      if (data) {
        date.value = data.date || "";
        start.value = data.start || "";
        end.value = data.end || "";
        breakMin.value = data.breakMin ?? 0;
        notes.value = data.notes || "";
        if (nextDay && typeof data.nextDay === "boolean") nextDay.checked = data.nextDay;
      }

      const recalc = () => {
        const dur = computeDuration(start.value, end.value, breakMin.value, nextDay && nextDay.checked);
        out.textContent = dur.toFixed(2);
        computeGrand();
        debouncedSave();
      };

      [date, start, end, breakMin, notes].forEach(el => {
        el.addEventListener("input", recalc);
        el.addEventListener("change", recalc);
      });
      if (nextDay) {
        nextDay.addEventListener("change", recalc);
      }

      // init values
      recalc();
      els.tableBody.appendChild(node);
    }

    function deleteSelectedRows() {
      const rows = Array.from(els.tableBody.querySelectorAll("tr"));
      const toDelete = rows.filter(tr => tr.querySelector('input[type="checkbox"]').checked);
      if (!toDelete.length) return;
      if (!confirm(`Ștergi ${toDelete.length} rând(uri)?`)) return;
      toDelete.forEach(tr => tr.remove());
      if (!els.tableBody.querySelector("tr")) addRow({});
      computeGrand();
      save();
    }

    function exportCSV() {
      const sep = ","; // pentru Excel RO poți schimba în ";"
      const header = ["Angajat","Data","Început","Sfârșit","Zi următoare","Pauză (min)","Activitate","Ore"];
      const lines = [header.join(sep)];
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const [chk, date, start, end, breakMin, notes, out] = tr.querySelectorAll("input, textarea, output");
        const nextDay = tr.querySelector('input.next-day-toggle');
        const row = [
          escapeCSV(currentWorker()),
          date.value,
          start.value,
          end.value,
          (nextDay && nextDay.checked) ? "da" : "nu",
          breakMin.value || 0,
          escapeCSV(notes.value),
          out.textContent || "0"
        ];
        lines.push(row.join(sep));
      });
      const blob = new Blob(["\uFEFF" + lines.join("\r\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `pontaj_${slug(currentWorker())}_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function escapeCSV(s) {
      if (s == null) return "";
      const str = String(s);
      return (/[",\r\n]/.test(str)) ? '"' + str.replace(/"/g, '""') + '"' : str;
    }

    // ---------- Events ----------
    els.addRow.addEventListener("click", () => { addRow({}); save(); });
    els.deleteSelected.addEventListener("click", deleteSelectedRows);
    els.exportCSV.addEventListener("click", exportCSV);
    els.printBtn.addEventListener("click", () => window.print());
    els.resetData.addEventListener("click", () => {
      if (!confirm("Sigur ștergi toate datele angajatului curent?")) return;
      localStorage.removeItem(storageKey());
      els.tableBody.innerHTML = "";
      addRow({});
      computeGrand();
      save();
    });

    // Worker handling
    (function initWorkers(){
      els.workerSelect.value = WORKERS[0];
      els.workerName.classList.add("hidden");

      els.workerSelect.addEventListener("change", () => {
        if (els.workerSelect.value === "__custom") {
          els.workerName.classList.remove("hidden");
          els.workerName.focus();
        } else {
          els.workerName.classList.add("hidden");
          els.workerName.value = "";
        }
        load();
      });

      els.workerName.addEventListener("input", () => {
        // tiny validation
        if (els.workerName.value.trim().length < 2) {
          els.workerName.setCustomValidity("Numele trebuie să aibă cel puțin 2 caractere");
        } else {
          els.workerName.setCustomValidity("");
        }
        load();
      });
    })();

    // Init
    (function init(){
      load();                       // încarcă din localStorage pentru primul angajat
      if (!els.tableBody.querySelector("tr")) addRow({}); // asigură un rând
    })();
  </script>
</body>
</html>
