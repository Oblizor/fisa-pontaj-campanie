<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
  </script>
  <title>FiÈ™Äƒ de Pontaj â€“ CramÄƒ (GitHub Storage)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial; }

    /* Print-friendly A4 */
    @page { size: A4; margin: 14mm; }
    @media print {
      .no-print { display: none !important; }
      .print-block { display: block !important; }
      .shadow-md, .shadow { box-shadow: none !important; }
      .ring-1 { box-shadow: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      tr { page-break-inside: avoid; }
    }

    .focusable:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.6); border-radius: .5rem; }
    
    /* Status indicator styles */
    .status-indicator { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; transition: background-color 0.3s ease; }
    .status-saved   { background-color:#10b981; /* Green */ }
    .status-saving  { background-color:#f59e0b; /* Amber */ animation:pulse 2s infinite; }
    .status-error   { background-color:#ef4444; /* Red */ }
    .status-offline { background-color:#6b7280; /* Gray */ }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

    .github-setup { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(-4px); } to { opacity:1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">
  <a href="#content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white px-3 py-2 rounded-md shadow">Sari la conÈ›inut</a>

  <header class="bg-white dark:bg-gray-800 shadow-sm no-print">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold dark:text-gray-100">FiÈ™Äƒ de Pontaj â€“ CramÄƒ</h1>
        <div id="statusContainer" class="flex items-center mt-1">
          <span id="statusIndicator" class="status-indicator status-offline"></span>
          <span id="statusText" class="text-sm text-gray-500 dark:text-gray-400">ConfigureazÄƒ GitHub</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <button id="themeToggle" class="focusable px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700">ğŸŒ™</button>
        <div class="text-sm text-gray-500 dark:text-gray-400">Versiunea 3.4</div>
      </div>
    </div>
  </header>

  <main id="content" class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <div id="githubStatus" class="no-print mb-6 p-4 rounded-lg github-setup text-white shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-medium">Sincronizare GitHub</h3>
          <p class="text-sm opacity-90">Datele sunt sincronizate cu un repository GitHub.</p>
        </div>
        <button id="openGithubConfig" class="focusable bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-semibold">ConfigureazÄƒ</button>
      </div>
    </div>

    <div id="githubModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden no-print">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 sm:p-8" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="flex justify-between items-center mb-4">
          <h2 id="modal-title" class="text-lg font-semibold">Configurare GitHub Storage</h2>
          <button id="closeGithubModal" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-100">&times;</button>
        </div>
        <div class="space-y-4">
          <div>
            <label for="githubToken" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Token de acces personal</label>
            <input id="githubToken" type="password" class="focusable mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">NecesitÄƒ permisiuni de `repo` sau `contents:read/write`.</p>
          </div>
          <div>
            <label for="githubRepo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Repository (format: `utilizator/repo`)</label>
            <input id="githubRepo" type="text" class="focusable mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border" placeholder="ex: ion-popescu/pontaj-data" />
          </div>
          <div class="flex gap-2 pt-2">
            <button id="saveGithubConfig" class="focusable flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">SalveazÄƒ È™i Ã®nchide</button>
            <button id="testConnection" class="focusable flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 font-semibold">TesteazÄƒ conexiunea</button>
          </div>
          <div id="githubError" class="mt-2 text-sm text-red-600 dark:text-red-500 hidden font-medium"></div>
        </div>
      </div>
    </div>

    <div id="reportsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden no-print">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full p-6 sm:p-8" role="dialog" aria-modal="true" aria-labelledby="reports-title">
        <div class="flex justify-between items-center mb-4">
          <h2 id="reports-title" class="text-lg font-semibold">Rapoarte</h2>
          <button id="closeReportsModal" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-100">&times;</button>
        </div>
        <div class="space-y-4">
          <div class="flex gap-2">
            <input id="reportFrom" type="date" class="focusable flex-1 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 px-3 py-2 border" />
            <input id="reportTo" type="date" class="focusable flex-1 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 px-3 py-2 border" />
            <button id="generateReportBtn" class="focusable bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">GenereazÄƒ</button>
          </div>
          <pre id="reportOutput" class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg overflow-auto max-h-96 text-sm"></pre>
        </div>
      </div>
    </div>

    <section class="no-print mb-4 grid grid-cols-2 sm:grid-cols-3 lg:flex gap-2">
      <button id="addRow" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">AdaugÄƒ rÃ¢nd</button>
      <button id="deleteSelected" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">È˜terge selectatele</button>
      <button id="exportCSV" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Export CSV</button>
      <button id="printBtn" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800">PrinteazÄƒ</button>
      <button id="resetData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600">ReseteazÄƒ date</button>
      <button id="syncData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">SincronizeazÄƒ</button>
      <button id="viewReports" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Rapoarte</button>
    </section>

    <form id="timesheetForm" class="bg-white dark:bg-gray-800 rounded-xl shadow-md ring-1 ring-gray-200 dark:ring-gray-700 overflow-hidden">
      <div class="p-4 sm:p-6">
        <div class="max-w-sm">
          <label for="workerSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Angajat (CramÄƒ)</label>
          <select id="workerSelect" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border">
            <option value="PricÄƒ JeniÈ›a">PricÄƒ JeniÈ›a</option>
            <option value="Neagu Marian">Neagu Marian</option>
            <option value="Banu MiticÄƒ">Banu MiticÄƒ</option>
            <option value="PricÄƒ Emilian">PricÄƒ Emilian</option>
            <option value="__custom">Alt numeâ€¦</option>
          </select>
          <input id="workerName" type="text" class="mt-2 hidden w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border" placeholder="Introdu numele" />
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th scope="col" class="px-3 py-2 text-left font-semibold">âœ”</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Data</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Ãnceput</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">SfÃ¢rÈ™it</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">PauzÄƒ (min)</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Activitate / ObservaÈ›ii</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Ore</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
          <tfoot class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <td colspan="6" class="px-3 py-3 text-right font-semibold">Total general (ore):</td>
              <td class="px-3 py-3 text-right"><span id="grandTotal" class="font-bold">0.00</span></td>
            </tr>
          </tfoot>
        </table>
      </div>
       <div class="p-4 grid sm:grid-cols-2 gap-6 print-block hidden">
        <div>
          <p class="font-semibold">Ãntocmit de:</p>
          <div class="h-16 border-b"></div>
        </div>
        <div>
          <p class="font-semibold">Confirmat (Responsabil cramÄƒ):</p>
          <div class="h-16 border-b"></div>
        </div>
      </div>
    </form>
     <p class="mt-3 text-xs text-gray-500 dark:text-gray-400 no-print">Hint: DacÄƒ o turÄƒ trece de miezul nopÈ›ii, bifeazÄƒ â€Zi urmÄƒtoareâ€ pe rÃ¢ndul respectiv.</p>
  </main>

  <footer class="no-print border-t bg-white dark:bg-gray-800 dark:border-gray-700 mt-8">
    <div class="max-w-5xl mx-auto px-4 py-3 text-xs text-gray-500 dark:text-gray-400">Â© <span id="year"></span> â€“ FiÈ™Äƒ de Pontaj CramÄƒ</div>
  </footer>

<template id="rowTemplate">
  <tr>
    <td class="px-3 py-2 align-top">
      <input type="checkbox" aria-label="SelecteazÄƒ rÃ¢nd" class="row-select focusable w-4 h-4" />
    </td>
    <td class="px-3 py-2 align-top">
      <input class="row-date focusable block w-40 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 px-2 py-1 border" />
    </td>
    <td class="px-3 py-2 align-top">
      <div class="flex items-center gap-2">
        <button type="button" class="start-stop focusable px-2 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-xs font-semibold">Start</button>
        <input class="row-start focusable block w-28 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 px-2 py-1 border" />
      </div>
    </td>
    <td class="px-3 py-2 align-top">
      <div class="flex items-center gap-2">
        <input class="row-end focusable block w-28 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 px-2 py-1 border" />
        <label class="inline-flex items-center gap-1 text-xs text-gray-600 dark:text-gray-300 select-none">
          <input type="checkbox" class="next-day-toggle focusable" />
          <span>Zi urmÄƒtoare</span>
        </label>
      </div>
    </td>
    <td class="px-3 py-2 align-top">
      <input type="number" min="0" step="5" value="0" class="row-break focusable block w-24 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 px-2 py-1 border" />
    </td>
    <td class="px-3 py-2 align-top">
      <textarea rows="1" class="row-notes focusable block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 px-2 py-1 border" placeholder="ex: cules, sortare..."></textarea>
    </td>
    <td class="px-3 py-2 align-top text-right">
      <output class="rowTotal font-medium">0.00</output>
    </td>
  </tr>
</template>

  <script type="module">
    import { generateReport, formatReport } from './report-client.js';
    document.addEventListener("DOMContentLoaded", () => {
      // --- State, Helpers & Elements ---
      const WORKERS = ["PricÄƒ JeniÈ›a", "Neagu Marian", "Banu MiticÄƒ", "PricÄƒ Emilian"];
      const els = {
        tableBody: document.getElementById("tableBody"), rowTmpl: document.getElementById("rowTemplate"),
        grandTotal: document.getElementById("grandTotal"), addRow: document.getElementById("addRow"),
        deleteSelected: document.getElementById("deleteSelected"), exportCSV: document.getElementById("exportCSV"),
        printBtn: document.getElementById("printBtn"), resetData: document.getElementById("resetData"),
        syncData: document.getElementById("syncData"), workerSelect: document.getElementById("workerSelect"),
        workerName: document.getElementById("workerName"), githubModal: document.getElementById("githubModal"),
        openGithubConfig: document.getElementById("openGithubConfig"), closeGithubModal: document.getElementById("closeGithubModal"),
        githubToken: document.getElementById("githubToken"), githubRepo: document.getElementById("githubRepo"),
        saveGithubConfig: document.getElementById("saveGithubConfig"), testConnection: document.getElementById("testConnection"),
        statusIndicator: document.getElementById("statusIndicator"), statusText: document.getElementById("statusText"),
        githubError: document.getElementById("githubError"), year: document.getElementById("year"),
        themeToggle: document.getElementById("themeToggle"), viewReports: document.getElementById("viewReports"),
        reportsModal: document.getElementById("reportsModal"), closeReportsModal: document.getElementById("closeReportsModal"),
        reportFrom: document.getElementById("reportFrom"), reportTo: document.getElementById("reportTo"),
        generateReportBtn: document.getElementById("generateReportBtn"), reportOutput: document.getElementById("reportOutput"),
      };
      
      let githubConfig = { token: '', repo: '' };
      let saveTimeout = null;

      flatpickr(els.reportFrom, {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y"
      });
      flatpickr(els.reportTo, {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y"
      });

      const slug = s => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      const currentWorker = () => els.workerSelect.value === "__custom" ? (els.workerName.value.trim() || "custom") : els.workerSelect.value;
      const getFileName = () => `data/pontaj_${slug(currentWorker())}.json`;
      const getLocalStorageKey = () => `pontaj-v3.4-local-${slug(currentWorker())}`;

      const formatDateRO = date =>
        date.toLocaleDateString('ro-RO', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        }).replace(/\./g, '/');
      const formatTimeRO = date =>
        date.toLocaleTimeString('ro-RO', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
      const formatDateTimeRO = date => `${formatDateRO(date)} ${formatTimeRO(date)}`;

      function updateStatus(status, msg) {
        els.statusIndicator.className = `status-indicator status-${status}`;
        els.statusText.textContent = msg;
        if (status === 'error') {
          showErrorInModal(msg);
        } else {
          hideErrorInModal();
        }
      }
      
      function showErrorInModal(msg) {
        els.githubError.textContent = msg;
        els.githubError.classList.remove("hidden");
      }

      function hideErrorInModal() {
        els.githubError.classList.add("hidden");
      }

      function updateThemeButton() {
        els.themeToggle.textContent = document.documentElement.classList.contains("dark") ? "ğŸŒ" : "ğŸŒ™";
      }

      // --- GitHub API Communication ---
      async function githubRequest(endpoint, options = {}) {
        if (!githubConfig.token || !githubConfig.repo) throw new Error("GitHub nu este configurat.");
        const [owner, repo] = githubConfig.repo.split("/");
        if (!owner || !repo) throw new Error("Formatul repository-ului este invalid. FoloseÈ™te `utilizator/repo`.");
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${endpoint}`;
        const resp = await fetch(url, {
          ...options,
          headers: { 'Authorization': `Bearer ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json', ...(options.headers || {}) },
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ message: `Eroare reÈ›ea: ${resp.statusText}` }));
          throw new Error(err.message || `Eroare HTTP ${resp.status}`);
        }
        return resp.json();
      }

      async function saveToGitHub(data) {
        if (!githubConfig.token || !githubConfig.repo) return; // Fail silently if not configured
        updateStatus("saving", "SalveazÄƒ pe GitHub...");
        try {
          const path = getFileName();
          const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
          let sha;
          try {
            const existing = await githubRequest(path);
            sha = existing.sha;
          } catch (e) {
             // File doesn't exist, which is fine.
          }
          const payload = {
            message: `Update: ${currentWorker()} â€“ ${formatDateTimeRO(new Date())}`,
            content,
            ...(sha ? { sha } : {}),
          };
          await githubRequest(path, { method: "PUT", body: JSON.stringify(payload) });
          updateStatus("saved", `Sincronizat la ${formatTimeRO(new Date())}`);
        } catch (e) {
          updateStatus("error", `Eroare GitHub: ${e.message}`);
        }
      }

      async function loadFromGitHub() {
        if (!githubConfig.token || !githubConfig.repo) return null;
        updateStatus("saving", "ÃncarcÄƒ de pe GitHub...");
        try {
          const data = await githubRequest(getFileName());
          const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
          updateStatus("saved", "Date Ã®ncÄƒrcate de pe GitHub");
          return content;
        } catch (e) {
          if (e.message.includes("Not Found")) {
             updateStatus("saved", "FiÈ™ier nou. SalveazÄƒ pentru a-l crea.");
          } else {
             updateStatus("error", `Eroare la Ã®ncÄƒrcare: ${e.message}`);
          }
          return null; // Return null to indicate we should use local data
        }
      }
      
      // --- Core Application Logic ---
      const computeDuration = (start, end, breakMin, isNextDay) => {
        if (!start || !end) return 0;
        const [sh, sm] = start.split(":").map(Number);
        const [eh, em] = end.split(":").map(Number);
        let startMins = sh * 60 + sm;
        let endMins = eh * 60 + em;
        if (isNextDay || endMins < startMins) endMins += 24 * 60;
        return Math.max(0, endMins - startMins - (parseInt(breakMin, 10) || 0)) / 60;
      };

      const computeGrand = () => {
        let total = 0;
        els.tableBody.querySelectorAll("tr").forEach(tr => total += parseFloat(tr.querySelector("output.rowTotal").textContent || 0));
        els.grandTotal.textContent = total.toFixed(2);
      };

Â  Â  const getTableData = () => {
Â  Â  Â  Â  const rows = [];
Â  Â  Â  Â  els.tableBody.querySelectorAll("tr").forEach(tr => {
Â  Â  Â  Â  Â  // Folosim selectori de clasÄƒ specifici, nu selectori generici de tag-uri
Â  Â  Â  Â  Â  const dateEl = tr.querySelector(".row-date");
Â  Â  Â  Â  Â  const startEl = tr.querySelector(".row-start");
Â  Â  Â  Â  Â  const endEl = tr.querySelector(".row-end");
Â  Â  Â  Â  Â  const breakEl = tr.querySelector(".row-break");
Â  Â  Â  Â  Â  const notesEl = tr.querySelector(".row-notes");
Â  Â  Â  Â  Â  const nextDayEl = tr.querySelector(".next-day-toggle");

Â  Â  Â  Â  Â  rows.push({
Â  Â  Â  Â  Â  Â  date: dateEl ? dateEl.value : "",
Â  Â  Â  Â  Â  Â  start: startEl ? startEl.value : "",
Â  Â  Â  Â  Â  Â  end: endEl ? endEl.value : "",
Â  Â  Â  Â  Â  Â  nextDay: !!(nextDayEl && nextDayEl.checked),
Â  Â  Â  Â  Â  Â  breakMin: breakEl ? parseInt(breakEl.value || 0, 10) : 0,
Â  Â  Â  Â  Â  Â  notes: notesEl ? notesEl.value : "",
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  meta: { worker: currentWorker(), lastUpdated: new Date().toISOString(), version: "3.4" },
Â  Â  Â  Â  Â  rows,
Â  Â  Â  Â  };
Â  Â  Â  };

      function save() {
        const data = getTableData();
        // Save to local storage as a backup/for offline use
        localStorage.setItem(getLocalStorageKey(), JSON.stringify(data));
        // Save to GitHub
        saveToGitHub(data);
      }
      
      const debouncedSave = () => {
        clearTimeout(saveTimeout);
        updateStatus("saving", "AÈ™teaptÄƒ...");
        saveTimeout = setTimeout(save, 1000);
      };

      async function load() {
        els.tableBody.innerHTML = "";
        let data = await loadFromGitHub(); // Try GitHub first
        if (!data) { // If GitHub fails or is empty, try local storage
          const localRaw = localStorage.getItem(getLocalStorageKey());
          try {
            data = localRaw ? JSON.parse(localRaw) : null;
            if(data) updateStatus("offline", "Date locale. ConecteazÄƒ-te pentru a sincroniza.");
          } catch { data = null; }
        }
        
        const list = (data && data.rows && data.rows.length) ? data.rows : [{}];
        list.forEach(r => addRowUI(r));
        computeGrand();
        // Save locally after loading from GitHub to create a backup
        if(data) localStorage.setItem(getLocalStorageKey(), JSON.stringify(data));
      }

      // --- UI Functions ---
      function addRowUI(data) {
        if (!data || Object.keys(data).length === 0) {
          const lastRow = els.tableBody.querySelector("tr:last-child");
          if (lastRow) {
            const lastEnd = lastRow.querySelector('.row-end')?.value || "";
            data = { start: lastEnd };
          }
        }

          const node = els.rowTmpl.content.cloneNode(true);
          const chk = node.querySelector("input.row-select");
          const date = node.querySelector(".row-date");
          const start = node.querySelector(".row-start");
          const end = node.querySelector(".row-end");
          const breakMin = node.querySelector(".row-break");
          const notes = node.querySelector(".row-notes");
          const out = node.querySelector("output.rowTotal");
          const nextDay = node.querySelector(".next-day-toggle");
          const startStopBtn = node.querySelector("button.start-stop");
          // removed currentTime element since it doesn't exist in template

        flatpickr(date, {
          dateFormat: "Y-m-d",
          altInput: true,
          altFormat: "d/m/Y",
          defaultDate: data && data.date ? data.date : null,
          minDate: new Date(new Date().getFullYear(), 0, 1),
          maxDate: new Date(new Date().getFullYear(), 11, 31)
        });
        flatpickr(start, {
          enableTime: true,
          noCalendar: true,
          dateFormat: "H:i",
          time_24hr: true,
          defaultDate: data && data.start ? data.start : null
        });
        flatpickr(end, {
          enableTime: true,
          noCalendar: true,
          dateFormat: "H:i",
          time_24hr: true,
          defaultDate: data && data.end ? data.end : null
        });

        if (data) {
          breakMin.value = data.breakMin ?? 0; notes.value = data.notes || "";
          if (nextDay && typeof data.nextDay === "boolean") nextDay.checked = data.nextDay;
        }

        const recalc = () => {
          const dur = computeDuration(start.value, end.value, breakMin.value, nextDay && nextDay.checked);
          out.textContent = dur.toFixed(2);
          computeGrand();
          debouncedSave();
        };

          [date, start, end, breakMin, notes, nextDay].forEach(el => el && el.addEventListener("input", recalc));

        let timer = null;
        startStopBtn.addEventListener("click", () => {
            if (timer) {
              clearInterval(timer);
              timer = null;
              const now = new Date();
              const t = now.toTimeString().slice(0,5);
              end._flatpickr.setDate(t, true, "H:i");
              startStopBtn.textContent = "Start";
              startStopBtn.classList.remove("bg-red-600", "hover:bg-red-700");
              startStopBtn.classList.add("bg-green-600", "hover:bg-green-700");
              recalc();
            } else {
              const now = new Date();
              const t = now.toTimeString().slice(0,5);
              start._flatpickr.setDate(t, true, "H:i");
              end._flatpickr.setDate(t, true, "H:i");
              startStopBtn.textContent = "Stop";
              startStopBtn.classList.remove("bg-green-600", "hover:bg-green-700");
              startStopBtn.classList.add("bg-red-600", "hover:bg-red-700");
              recalc();
              timer = setInterval(() => {
                const now = new Date();
                const tt = now.toTimeString().slice(0,5);
                end._flatpickr.setDate(tt, true, "H:i");
                recalc();
              }, 1000);
            }
          });

        recalc();
        const tr = node.querySelector("tr");
        tr.classList.add("fade-in");
        els.tableBody.appendChild(node);
      }
      
      const deleteSelectedRows = () => {
        const toDelete = Array.from(els.tableBody.querySelectorAll("tr")).filter(tr => tr.querySelector('input[type="checkbox"]').checked);
        if (!toDelete.length) return;
        if (!confirm(`Sigur doreÈ™ti sÄƒ È™tergi ${toDelete.length} rÃ¢nd(uri)?`)) return;
        toDelete.forEach(tr => tr.remove());
        if (!els.tableBody.querySelector("tr")) addRowUI({});
        computeGrand();
        save();
      };

      const runReport = async () => {
        els.reportOutput.textContent = 'Se genereazÄƒ...';
        const from = els.reportFrom.value;
        const to = els.reportTo.value;
        const timesheets = [];
        for (const w of WORKERS) {
          const path = `data/pontaj_${slug(w)}.json`;
          let data = null;
          try {
            const res = await githubRequest(path);
            data = JSON.parse(decodeURIComponent(escape(atob(res.content))));
          } catch (e) {
            const local = localStorage.getItem(`pontaj-v3.4-local-${slug(w)}`);
            if (local) {
              try { data = JSON.parse(local); } catch { data = null; }
            }
          }
          if (data) timesheets.push(data);
        }
        const rep = generateReport(timesheets, from, to);
        const formatted = formatReport(rep);
        els.reportOutput.textContent = formatted || 'Nicio activitate pentru perioada selectatÄƒ.';
      };
      
      // --- Event Listeners & Init ---
      function setupEventListeners() {
        els.addRow.addEventListener("click", () => { addRowUI({}); save(); });
        els.deleteSelected.addEventListener("click", deleteSelectedRows);
        els.printBtn.addEventListener("click", () => window.print());
        els.syncData.addEventListener("click", load);
        
        els.resetData.addEventListener("click", () => {
          if (!confirm(`AtenÈ›ie! Aceasta va È™terge TOA datele pentru ${currentWorker()} din browser È™i de pe GitHub. Continui?`)) return;
          localStorage.removeItem(getLocalStorageKey());
          els.tableBody.innerHTML = "";
          addRowUI({});
          save(); // This will save an empty state to GitHub
        });

        // Worker selection
        els.workerSelect.addEventListener("change", () => {
          if (els.workerSelect.value === "__custom") {
            els.workerName.classList.remove("hidden");
            els.workerName.focus();
          } else {
            els.workerName.classList.add("hidden");
            els.workerName.value = "";
          }
          load();
        });
        els.workerName.addEventListener("input", load);

        // GitHub Modal
        els.openGithubConfig.addEventListener("click", () => els.githubModal.classList.remove("hidden"));
        els.closeGithubModal.addEventListener("click", () => els.githubModal.classList.add("hidden"));
        els.saveGithubConfig.addEventListener("click", () => {
          githubConfig.token = els.githubToken.value;
          githubConfig.repo = els.githubRepo.value;
          localStorage.setItem('pontaj-github-config', JSON.stringify(githubConfig));
          els.githubModal.classList.add("hidden");
          testGitHubConnection(); // Test and then load
        });
        els.testConnection.addEventListener("click", testGitHubConnection);

        els.exportCSV.addEventListener("click", () => { /* Add export logic here if needed */ });

        els.viewReports.addEventListener("click", () => els.reportsModal.classList.remove("hidden"));
        els.closeReportsModal.addEventListener("click", () => els.reportsModal.classList.add("hidden"));
        els.generateReportBtn.addEventListener("click", runReport);

        els.themeToggle.addEventListener("click", () => {
          document.documentElement.classList.toggle("dark");
          const theme = document.documentElement.classList.contains("dark") ? "dark" : "light";
          localStorage.setItem("theme", theme);
          updateThemeButton();
        });
      }

      async function testGitHubConnection() {
        githubConfig.token = els.githubToken.value;
        githubConfig.repo = els.githubRepo.value;
        updateStatus("saving", "Testare...");
        try {
          const [owner, repo] = githubConfig.repo.split("/");
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}`, { headers: { Authorization: `Bearer ${githubConfig.token}` } });
          if (resp.ok) {
            updateStatus("saved", `Conectat la ${owner}/${repo}`);
            hideErrorInModal();
            load();
            return true;
          }
          const err = await resp.json();
          throw new Error(err.message || `HTTP ${resp.status}`);
        } catch (e) {
          updateStatus("error", e.message);
          return false;
        }
      }
      
      // Initializer function
      function init() {
        els.year.textContent = new Date().getFullYear();
        
        // Load GitHub config from local storage
        const savedConfig = localStorage.getItem('pontaj-github-config');
        if (savedConfig) {
          githubConfig = JSON.parse(savedConfig);
          els.githubToken.value = githubConfig.token;
          els.githubRepo.value = githubConfig.repo;
        }

        // Setup UI and load data
        els.workerSelect.value = WORKERS[0];
        setupEventListeners();
        updateThemeButton();
        
        if (githubConfig.token && githubConfig.repo) {
            testGitHubConnection();
        } else {
            updateStatus("offline", "ConfigureazÄƒ GitHub pentru a sincroniza.");
        }
      }

      init();
    });
  </script>
</body>
</html>
