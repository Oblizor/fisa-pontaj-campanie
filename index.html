<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fișă de Pontaj – Cramă (GitHub Storage)</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* Print-friendly A4 */
    @page { size: A4; margin: 14mm; }
    @media print {
      .no-print { display: none !important; }
      .print-block { display: block !important; }
      .shadow-md, .shadow { box-shadow: none !important; }
      .ring-1 { box-shadow: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
    }

    /* Improve focus ring for accessibility */
    .focusable:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.6); border-radius: .5rem; }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-saved { background-color: #10b981; }
    .status-saving { background-color: #f59e0b; animation: pulse 2s infinite; }
    .status-error { background-color: #ef4444; }
    .status-offline { background-color: #6b7280; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .github-setup { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <a href="#content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white px-3 py-2 rounded-md shadow">Sari la conținut</a>

  <header class="bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold">Fișă de Pontaj – Cramă</h1>
        <div class="flex items-center mt-1">
          <span id="statusIndicator" class="status-indicator status-offline"></span>
          <span id="statusText" class="text-sm text-gray-500">Configurează GitHub</span>
        </div>
      </div>
      <div class="text-sm text-gray-500">Versiunea 3.0</div>
    </div>
  </header>

  <!-- GitHub Setup Modal -->
  <div id="githubModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
      <h2 class="text-lg font-semibold mb-4">Configurare GitHub Storage</h2>
      <div class="space-y-4">
        <div>
          <label for="githubToken" class="block text-sm font-medium text-gray-700">Token de acces GitHub</label>
          <input id="githubToken" type="password" class="mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
          <p class="mt-1 text-xs text-gray-500">Creează un Personal Access Token în GitHub Settings → Developer Settings</p>
        </div>
        <div>
          <label for="githubRepo" class="block text-sm font-medium text-gray-700">Repository (user/repo)</label>
          <input id="githubRepo" type="text" class="mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="username/pontaj-data" />
        </div>
        <div class="flex gap-2">
          <button id="saveGithubConfig" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvează</button>
          <button id="testConnection" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Test conexiune</button>
        </div>
      </div>
    </div>
  </div>

  <main id="content" class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- GitHub Status -->
    <div id="githubStatus" class="mb-4 p-3 rounded-lg github-setup text-white">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-medium">GitHub Storage</h3>
          <p class="text-sm opacity-90">Datele sunt salvate automat în repository-ul GitHub configurat</p>
        </div>
        <button id="openGithubConfig" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm">
          Configurează
        </button>
      </div>
    </div>

    <!-- Panou acțiuni -->
    <section class="no-print mb-4 grid grid-cols-2 sm:flex gap-2">
      <button id="addRow" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Adaugă rând</button>
      <button id="deleteSelected" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Șterge selectatele</button>
      <button id="exportCSV" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Export CSV</button>
      <button id="printBtn" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800">Printează</button>
      <button id="resetData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600">Resetează date</button>
      <button id="syncData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">Sincronizează</button>
    </section>

    <!-- Formular + tabel -->
    <form id="timesheetForm" class="bg-white rounded-xl shadow-md ring-1 ring-gray-200 overflow-hidden">
      <div class="p-4 sm:p-6">
        <div class="max-w-sm">
          <label for="workerSelect" class="block text-sm font-medium text-gray-700">Angajat (Cramă)</label>
          <select id="workerSelect" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
            <option value="Prică Jenița">Prică Jenița</option>
            <option value="Neagu Marian">Neagu Marian</option>
            <option value="Banu Mitică">Banu Mitică</option>
            <option value="Prică Emilian">Prică Emilian</option>
            <option value="__custom">Alt nume…</option>
          </select>
          <input id="workerName" name="workerName" type="text" class="mt-2 hidden w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="Introdu numele" />
          <p class="mt-1 text-xs text-gray-500">Pontajul se salvează separat pentru fiecare angajat în GitHub.</p>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-3 py-2 text-left font-semibold">✔</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Data</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Început</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Sfârșit</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Pauză (min)</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Activitate / Observații</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Ore</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="6" class="px-3 py-3 text-right font-semibold">Total general (ore):</td>
              <td class="px-3 py-3 text-right"><span id="grandTotal" class="font-bold">0.00</span></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="p-4 grid sm:grid-cols-2 gap-6 print-block hidden">
        <div>
          <p class="font-semibold">Întocmit de:</p>
          <div class="h-16 border-b"></div>
        </div>
        <div>
          <p class="font-semibold">Confirmat (Responsabil cramă):</p>
          <div class="h-16 border-b"></div>
        </div>
      </div>

      <div aria-live="polite" id="errorArea" class="sr-only"></div>
    </form>
  </main>

  <footer class="no-print border-t bg-white">
    <div class="max-w-5xl mx-auto px-4 py-3 text-xs text-gray-500">© <span id="year"></span> – Fișă de Pontaj Cramă cu GitHub Storage. Pământul ne inspiră, pasiunea ne unește.</div>
  </footer>

  <template id="rowTemplate">
    <tr>
      <td class="px-3 py-2 align-top">
        <input type="checkbox" aria-label="Selectează rând" class="focusable w-4 h-4" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Data</label>
        <input type="date" class="focusable mt-1 block w-40 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Început</label>
        <input type="time" step="60" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Sfârșit</label>
        <input type="time" step="60" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Pauză (minute)</label>
        <input type="number" min="0" step="5" value="0" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Activitate</label>
        <textarea rows="1" class="focusable mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="ex: cules, sortare, transport…"></textarea>
      </td>
      <td class="px-3 py-2 align-top text-right">
        <output class="rowTotal font-medium">0.00</output>
      </td>
    </tr>
  </template>

  <script>
    const WORKERS = [
      "Prică Jenița",
      "Neagu Marian",
      "Banu Mitică",
      "Prică Emilian",
    ];

    const els = {
      tableBody: document.getElementById("tableBody"),
      rowTmpl: document.getElementById("rowTemplate"),
      grandTotal: document.getElementById("grandTotal"),
      errorArea: document.getElementById("errorArea"),
      form: document.getElementById("timesheetForm"),
      addRow: document.getElementById("addRow"),
      deleteSelected: document.getElementById("deleteSelected"),
      exportCSV: document.getElementById("exportCSV"),
      printBtn: document.getElementById("printBtn"),
      resetData: document.getElementById("resetData"),
      syncData: document.getElementById("syncData"),
      year: document.getElementById("year"),
      workerSelect: document.getElementById("workerSelect"),
      workerName: document.getElementById("workerName"),
      githubModal: document.getElementById("githubModal"),
      githubToken: document.getElementById("githubToken"),
      githubRepo: document.getElementById("githubRepo"),
      saveGithubConfig: document.getElementById("saveGithubConfig"),
      testConnection: document.getElementById("testConnection"),
      openGithubConfig: document.getElementById("openGithubConfig"),
      statusIndicator: document.getElementById("statusIndicator"),
      statusText: document.getElementById("statusText"),
    };

    // GitHub Configuration
    let githubConfig = {
      token: localStorage.getItem('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') || '',
      repo: localStorage.getItem('Oblizor/fisa-pontaj-campanie') || '',
    };

    // Status Management
    function updateStatus(status, message) {
      els.statusIndicator.className = `status-indicator status-${status}`;
      els.statusText.textContent = message;
    }

    // Utils
    const slug = (s) => (s||"")
      .normalize('NFD').replace(/[̀-ͯ]/g, '') // remove diacritice
      .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');

    const currentWorker = () => {
      if (els.workerSelect.value === "__custom") return els.workerName.value.trim() || "custom";
      return els.workerSelect.value;
    };

    const getFileName = () => `pontaj_${slug(currentWorker())}.json`;

    // GitHub API Functions
    async function githubRequest(endpoint, options = {}) {
      if (!githubConfig.token || !githubConfig.repo) {
        throw new Error('GitHub nu este configurat');
      }

      const [owner, repo] = githubConfig.repo.split('/');
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${endpoint}`;
      
      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${githubConfig.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
          ...options.headers,
        },
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ message: 'Network error' }));
        throw new Error(error.message || `HTTP ${response.status}`);
      }

      return response.json();
    }

    async function saveToGitHub(data) {
      updateStatus('saving', 'Salvează în GitHub...');
      try {
        const fileName = getFileName();
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
        
        let sha;
        try {
          const existing = await githubRequest(fileName);
          sha = existing.sha;
        } catch (e) {
          // File doesn't exist, that's OK
        }

        const payload = {
          message: `Actualizare pontaj: ${currentWorker()} - ${new Date().toISOString()}`,
          content: content,
        };
        
        if (sha) payload.sha = sha;

        await githubRequest(fileName, {
          method: 'PUT',
          body: JSON.stringify(payload),
        });

        updateStatus('saved', 'Salvat în GitHub');
        setTimeout(() => updateStatus('saved', 'Sincronizat'), 2000);
        
      } catch (error) {
        console.error('Eroare salvare GitHub:', error);
        updateStatus('error', `Eroare: ${error.message}`);
        // Fallback to localStorage
        localStorage.setItem(`pontaj-backup-${slug(currentWorker())}`, JSON.stringify(data));
      }
    }

    async function loadFromGitHub() {
      if (!githubConfig.token || !githubConfig.repo) {
        return null;
      }

      updateStatus('saving', 'Încarcă din GitHub...');
      try {
        const fileName = getFileName();
        const response = await githubRequest(fileName);
        const content = JSON.parse(decodeURIComponent(escape(atob(response.content))));
        
        updateStatus('saved', 'Încărcat din GitHub');
        return content;
        
      } catch (error) {
        console.warn('Nu s-au putut încărca datele din GitHub:', error);
        updateStatus('offline', 'Offline - folosește backup local');
        // Fallback to localStorage
        const backup = localStorage.getItem(`pontaj-backup-${slug(currentWorker())}`);
        return backup ? JSON.parse(backup) : null;
      }
    }

    async function testGitHubConnection() {
      updateStatus('saving', 'Testează conexiunea...');
      try {
        const [owner, repo] = githubConfig.repo.split('/');
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            'Authorization': `Bearer ${githubConfig.token}`,
            'Accept': 'application/vnd.github.v3+json',
          },
        });

        if (response.ok) {
          updateStatus('saved', 'Conexiune GitHub OK');
          return true;
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        updateStatus('error', `Eroare conexiune: ${error.message}`);
        return false;
      }
    }

    // Modal Management
    function showGitHubModal() {
      els.githubToken.value = githubConfig.token;
      els.githubRepo.value = githubConfig.repo;
      els.githubModal.style.display = 'flex';
    }

    function hideGitHubModal() {
      els.githubModal.style.display = 'none';
    }

    els.year.textContent = new Date().getFullYear();

    function addRow(data) {
      const node = els.rowTmpl.content.cloneNode(true);
      const [chk, date, start, end, breakMin, notes, out] = node.querySelectorAll("input, textarea, output");

      if (data) {
        date.value = data.date || "";
        start.value = data.start || "";
        end.value = data.end || "";
        breakMin.value = data.breakMin ?? 0;
        notes.value = data.notes || "";
      }

      const recalc = () => {
        const dur = computeDuration(start.value, end.value, parseInt(breakMin.value||0,10));
        out.textContent = dur.toFixed(2);
        computeGrand();
        save();
      };

      [date, start, end, breakMin, notes].forEach(el => {
        el.addEventListener("input", recalc);
        el.addEventListener("change", recalc);
      });

      // init
      recalc();
      els.tableBody.appendChild(node);
    }

    function computeDuration(start, end, breakMinutes) {
      if (!start || !end) return 0;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let startM = sh*60 + sm;
      let endM = eh*60 + em;
      // allow crossing midnight (ex: 22:00 -> 02:00)
      if (endM < startM) endM += 24*60;
      let diff = Math.max(0, endM - startM - (breakMinutes||0));
      return diff/60;
    }

    function computeGrand() {
      let total = 0;
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const out = tr.querySelector("output.rowTotal");
        total += parseFloat(out.textContent||"0");
      });
      els.grandTotal.textContent = total.toFixed(2);
    }

    function save() {
      const rows = [];
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const [chk, date, start, end, breakMin, notes, out] = tr.querySelectorAll("input, textarea, output");
        rows.push({
          date: date.value || "",
          start: start.value || "",
          end: end.value || "",
          breakMin: parseInt(breakMin.value||0,10),
          notes: notes.value || "",
          hours: parseFloat(out.textContent||"0"),
        });
      });
      const payload = {
        meta: {
          worker: currentWorker(),
          lastUpdated: new Date().toISOString(),
          version: "3.0",
        },
        rows,
      };
      
      // Save to GitHub (async)
      saveToGitHub(payload);
    }

    async function load() {
      els.tableBody.innerHTML = "";
      const data = await loadFromGitHub();
      
      if (!data) { 
        addRow(); 
        computeGrand(); 
        return; 
      }
      
      try {
        (data.rows && data.rows.length ? data.rows : [{}]).forEach(r => addRow(r));
        computeGrand();
      } catch (e) {
        console.warn("Eroare la încărcare date:", e);
        addRow();
      }
    }

    function exportCSV() {
      const sep = ",";
      const header = [
        "Angajat",
        "Data",
        "Început",
        "Sfârșit",
        "Pauză (min)",
        "Activitate",
        "Ore"
      ];
      const lines = [header.join(sep)];
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const [chk, date, start, end, breakMin, notes, out] = tr.querySelectorAll("input, textarea, output");
        const row = [
          escapeCSV(currentWorker()),
          date.value,
          start.value,
          end.value,
          breakMin.value || 0,
          escapeCSV(notes.value),
          (out.textContent||"0")
        ];
        lines.push(row.join(sep));
      });
      const blob = new Blob(["﻿" + lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const fileName = `pontaj_${slug(currentWorker())}_${new Date().toISOString().slice(0,10)}.csv`;
      a.href = url; a.download = fileName; a.click();
      URL.revokeObjectURL(url);
    }

    function escapeCSV(s) {
      if (s == null) return "";
      const str = String(s);
      if (str.includes('"') || str.includes(',') || str.includes('\n') || str.includes(';')) {
        return '"' + str.replaceAll('"', '""') + '"';
      }
      return str;
    }

    function printSheet() { window.print(); }

    function deleteSelectedRows() {
      const rows = Array.from(els.tableBody.querySelectorAll("tr"));
      const toDelete = rows.filter(tr => tr.querySelector('input[type="checkbox"]').checked);
      if (!toDelete.length) return;
      if (!confirm(`Ștergi ${toDelete.length} rând(uri)?`)) return;
      toDelete.forEach(tr => tr.remove());
      if (!els.tableBody.querySelector("tr")) addRow();
      computeGrand();
      save();
    }

    // Events
    els.addRow.addEventListener("click", () => { addRow(); save(); });
    els.deleteSelected.addEventListener("click", deleteSelectedRows);
    els.exportCSV.addEventListener("click", exportCSV);
    els.printBtn.addEventListener("click", printSheet);
    els.syncData.addEventListener("click", load);
    els.resetData.addEventListener("click", async () => {
      if (confirm("Sigur ștergi toate datele angajatului curent?")) {
        els.tableBody.innerHTML = "";
        addRow();
        computeGrand();
        save();
      }
    });

    // GitHub Modal Events
    els.openGithubConfig.addEventListener("click", showGitHubModal);
    els.saveGithubConfig.addEventListener("click", () => {
      githubConfig.token = els.githubToken.value.trim();
      githubConfig.repo = els.githubRepo.value.trim();
      
      if (githubConfig.token && githubConfig.repo) {
        localStorage.setItem('github_token', githubConfig.token);
        localStorage.setItem('github_repo', githubConfig.repo);
        hideGitHubModal();
        updateStatus('saved', 'Configurat GitHub');
        load(); // Reload data from GitHub
      } else {
        alert('Te rog completează toate câmpurile!');
      }
    });

    els.testConnection.addEventListener("click", testGitHubConnection);

    // Close modal on outside click
    els.githubModal.addEventListener("click", (e) => {
      if (e.target === els.githubModal) hideGitHubModal();
    });

    // Worker selection
    (function initWorkers(){
      els.workerSelect.value = WORKERS[0];
      els.workerName.classList.add('hidden');

      els.workerSelect.addEventListener('change', () => {
        if (els.workerSelect.value === '__custom') {
          els.workerName.classList.remove('hidden');
          els.workerName.focus();
        } else {
          els.workerName.classList.add('hidden');
          els.workerName.value = '';
        }
        load();
      });

      els.workerName.addEventListener('input', load);
    })();

    // Initialize
    (async function init() {
      // Verifică dacă sunt valorile default (placeholder) sau sunt configurate
      const hasValidConfig = githubConfig.token && 
                            githubConfig.repo && 
                            !githubConfig.token.includes('XXXX') &&
                            !githubConfig.repo.includes('username');
      
      if (!hasValidConfig) {
        showGitHubModal();
      } else {
        await testGitHubConnection();
        await load();
      }
    })();
  </script>
</body>
</html>
