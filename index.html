<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fișă de Pontaj – Cramă (Interactivă)</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* Print-friendly A4 */
    @page { size: A4; margin: 14mm; }
    @media print {
      .no-print { display: none !important; }
      .print-block { display: block !important; }
      .shadow-md, .shadow { box-shadow: none !important; }
      .ring-1 { box-shadow: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
    }

    /* Improve focus ring for accessibility */
    .focusable:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.6); border-radius: .5rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <a href="#content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white px-3 py-2 rounded-md shadow">Sari la conținut</a>

  <header class="bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-semibold">Fișă de Pontaj – Cramă</h1>
      <div class="text-sm text-gray-500">Versiunea 2.1</div>
    </div>
  </header>

  <main id="content" class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Panou acțiuni -->
    <section class="no-print mb-4 grid grid-cols-2 sm:flex gap-2">
      <button id="addRow" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Adaugă rând</button>
      <button id="deleteSelected" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Șterge selectatele</button>
      <button id="exportCSV" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Export CSV</button>
      <button id="printBtn" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800">Printează</button>
      <button id="resetData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600">Resetează date</button>
    </section>

    <!-- Formular + tabel -->
    <form id="timesheetForm" class="bg-white rounded-xl shadow-md ring-1 ring-gray-200 overflow-hidden">
      <div class="p-4 sm:p-6 grid sm:grid-cols-3 gap-4">
        <div class="sm:col-span-1">
          <label for="workerSelect" class="block text-sm font-medium text-gray-700">Angajat (Cramă)</label>
          <select id="workerSelect" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
            <option value="Prică Jenița">Prică Jenița</option>
            <option value="Neagu Marian">Neagu Marian</option>
            <option value="Banu Mitică">Banu Mitică</option>
            <option value="Prică Emilian">Prică Emilian</option>
            <option value="__custom">Alt nume…</option>
          </select>
          <input id="workerName" name="workerName" type="text" class="mt-2 hidden w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="Introdu numele" />
          <p class="mt-1 text-xs text-gray-500">Pontajul se salvează separat pentru fiecare angajat.</p>
        </div>
        <div class="sm:col-span-2">
          <label for="campaign" class="block text-sm font-medium text-gray-700">Campanie / Parcelă</label>
          <input id="campaign" name="campaign" type="text" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="ex: Cules Muscat – Horia" />
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-3 py-2 text-left font-semibold">✔</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Data</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Început</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Sfârșit</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Pauză (min)</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Activitate / Observații</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Ore</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="6" class="px-3 py-3 text-right font-semibold">Total general (ore):</td>
              <td class="px-3 py-3 text-right"><span id="grandTotal" class="font-bold">0.00</span></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="p-4 grid sm:grid-cols-2 gap-6 print-block hidden">
        <div>
          <p class="font-semibold">Întocmit de:</p>
          <div class="h-16 border-b"></div>
        </div>
        <div>
          <p class="font-semibold">Confirmat (Responsabil cramă):</p>
          <div class="h-16 border-b"></div>
        </div>
      </div>

      <div aria-live="polite" id="errorArea" class="sr-only"></div>
    </form>

    <section class="mt-4 text-xs text-gray-500">
      <p>Notă: datele sunt salvate automat în browser (localStorage), separat pentru fiecare angajat ales.</p>
    </section>
  </main>

  <footer class="no-print border-t bg-white">
    <div class="max-w-5xl mx-auto px-4 py-3 text-xs text-gray-500">© <span id="year"></span> – Fișă de Pontaj Cramă. Pământul ne inspiră, pasiunea ne unește.</div>
  </footer>

  <template id="rowTemplate">
    <tr>
      <td class="px-3 py-2 align-top">
        <input type="checkbox" aria-label="Selectează rând" class="focusable w-4 h-4" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Data</label>
        <input type="date" class="focusable mt-1 block w-40 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Început</label>
        <input type="time" step="60" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Sfârșit</label>
        <input type="time" step="60" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Pauză (minute)</label>
        <input type="number" min="0" step="5" value="0" class="focusable mt-1 block w-28 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </td>
      <td class="px-3 py-2 align-top">
        <label class="sr-only">Activitate</label>
        <textarea rows="1" class="focusable mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="ex: cules, sortare, transport…"></textarea>
      </td>
      <td class="px-3 py-2 align-top text-right">
        <output class="rowTotal font-medium">0.00</output>
      </td>
    </tr>
  </template>

  <script>
    const WORKERS = [
      "Prică Jenița",
      "Neagu Marian",
      "Banu Mitică",
      "Prică Emilian",
    ];

    const els = {
      tableBody: document.getElementById("tableBody"),
      rowTmpl: document.getElementById("rowTemplate"),
      grandTotal: document.getElementById("grandTotal"),
      errorArea: document.getElementById("errorArea"),
      form: document.getElementById("timesheetForm"),
      addRow: document.getElementById("addRow"),
      deleteSelected: document.getElementById("deleteSelected"),
      exportCSV: document.getElementById("exportCSV"),
      printBtn: document.getElementById("printBtn"),
      resetData: document.getElementById("resetData"),
      year: document.getElementById("year"),
      workerSelect: document.getElementById("workerSelect"),
      workerName: document.getElementById("workerName"),
      campaign: document.getElementById("campaign"),
    };

    // Utils
    const slug = (s) => (s||"")
      .normalize('NFD').replace(/[̀-ͯ]/g, '') // remove diacritice
      .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');

    const storageKey = () => `pontaj-v2-${slug(currentWorker())}`;

    const currentWorker = () => {
      if (els.workerSelect.value === "__custom") return els.workerName.value.trim() || "custom";
      return els.workerSelect.value;
    };

    els.year.textContent = new Date().getFullYear();

    function addRow(data) {
      const node = els.rowTmpl.content.cloneNode(true);
      const [chk, date, start, end, breakMin, notes, out] = node.querySelectorAll("input, textarea, output");

      if (data) {
        date.value = data.date || "";
        start.value = data.start || "";
        end.value = data.end || "";
        breakMin.value = data.breakMin ?? 0;
        notes.value = data.notes || "";
      }

      const recalc = () => {
        const dur = computeDuration(start.value, end.value, parseInt(breakMin.value||0,10));
        out.textContent = dur.toFixed(2);
        computeGrand();
        save();
      };

      [date, start, end, breakMin, notes].forEach(el => {
        el.addEventListener("input", recalc);
        el.addEventListener("change", recalc);
      });

      // init
      recalc();
      els.tableBody.appendChild(node);
    }

    function computeDuration(start, end, breakMinutes) {
      if (!start || !end) return 0;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let startM = sh*60 + sm;
      let endM = eh*60 + em;
      // allow crossing midnight (ex: 22:00 -> 02:00)
      if (endM < startM) endM += 24*60;
      let diff = Math.max(0, endM - startM - (breakMinutes||0));
      return diff/60;
    }

    function computeGrand() {
      let total = 0;
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const out = tr.querySelector("output.rowTotal");
        total += parseFloat(out.textContent||"0");
      });
      els.grandTotal.textContent = total.toFixed(2);
    }

    function save() {
      const rows = [];
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const [chk, date, start, end, breakMin, notes, out] = tr.querySelectorAll("input, textarea, output");
        rows.push({
          date: date.value || "",
          start: start.value || "",
          end: end.value || "",
          breakMin: parseInt(breakMin.value||0,10),
          notes: notes.value || "",
          hours: parseFloat(out.textContent||"0"),
        });
      });
      const payload = {
        meta: {
          worker: currentWorker(),
          campaign: els.campaign.value || "",
        },
        rows,
      };
      localStorage.setItem(storageKey(), JSON.stringify(payload));
    }

    function load() {
      const raw = localStorage.getItem(storageKey());
      els.tableBody.innerHTML = "";
      if (!raw) { addRow(); computeGrand(); return; }
      try {
        const data = JSON.parse(raw);
        els.campaign.value = data.meta?.campaign || "";
        (data.rows && data.rows.length ? data.rows : [{}]).forEach(r => addRow(r));
        computeGrand();
      } catch (e) {
        console.warn("Eroare la încărcare date:", e);
        addRow();
      }
    }

    function exportCSV() {
      const sep = ","; // dacă preferi pentru Excel RO, schimbă în ";"
      const header = [
        "Angajat",
        "Campanie",
        "Data",
        "Început",
        "Sfârșit",
        "Pauză (min)",
        "Activitate",
        "Ore"
      ];
      const lines = [header.join(sep)];
      els.tableBody.querySelectorAll("tr").forEach(tr => {
        const [chk, date, start, end, breakMin, notes, out] = tr.querySelectorAll("input, textarea, output");
        const row = [
          escapeCSV(currentWorker()),
          escapeCSV(els.campaign.value),
          date.value,
          start.value,
          end.value,
          breakMin.value || 0,
          escapeCSV(notes.value),
          (out.textContent||"0")
        ];
        lines.push(row.join(sep));
      });
      const blob = new Blob(["﻿" + lines.join("
")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const fileName = `pontaj_${slug(currentWorker())}_${new Date().toISOString().slice(0,10)}.csv`;
      a.href = url; a.download = fileName; a.click();
      URL.revokeObjectURL(url);
    }

    function escapeCSV(s) {
      if (s == null) return "";
      const str = String(s);
      if (str.includes('"') || str.includes(',') || str.includes('
') || str.includes(';')) {
        return '"' + str.replaceAll('"', '""') + '"';
      }
      return str;
    }

    function printSheet() { window.print(); }

    function deleteSelectedRows() {
      const rows = Array.from(els.tableBody.querySelectorAll("tr"));
      const toDelete = rows.filter(tr => tr.querySelector('input[type="checkbox"]').checked);
      if (!toDelete.length) return;
      if (!confirm(`Ștergi ${toDelete.length} rând(uri)?`)) return;
      toDelete.forEach(tr => tr.remove());
      if (!els.tableBody.querySelector("tr")) addRow();
      computeGrand();
      save();
    }

    // Events
    els.addRow.addEventListener("click", () => { addRow(); save(); });
    els.deleteSelected.addEventListener("click", deleteSelectedRows);
    els.exportCSV.addEventListener("click", exportCSV);
    els.printBtn.addEventListener("click", printSheet);
    els.resetData.addEventListener("click", () => {
      if (confirm("Sigur ștergi toate datele angajatului curent?")) {
        localStorage.removeItem(storageKey());
        els.tableBody.innerHTML = "";
        els.campaign.value = "";
        addRow();
        computeGrand();
      }
    });

    els.campaign.addEventListener("input", save);

    // Populate worker selector and handle custom
    (function initWorkers(){
      // preselect first worker by default
      els.workerSelect.value = WORKERS[0];
      els.workerName.classList.add('hidden');

      els.workerSelect.addEventListener('change', () => {
        if (els.workerSelect.value === '__custom') {
          els.workerName.classList.remove('hidden');
          els.workerName.focus();
        } else {
          els.workerName.classList.add('hidden');
          els.workerName.value = '';
        }
        load();
      });

      els.workerName.addEventListener('input', () => {
        // reload storage when custom name actually changes
        load();
      });
    })();

    // init (loads default worker)
    load();
  </script>
</body>
</html>
