<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fișă de Pontaj – Cramă (GitHub Storage)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial; }

    /* Print-friendly A4 */
    @page { size: A4; margin: 14mm; }
    @media print {
      .no-print { display: none !important; }
      .print-block { display: block !important; }
      .shadow-md, .shadow { box-shadow: none !important; }
      .ring-1 { box-shadow: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      tr { page-break-inside: avoid; }
    }

    .focusable:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.6); border-radius: .5rem; }
    
    /* Status indicator styles */
    .status-indicator { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; transition: background-color 0.3s ease; }
    .status-saved   { background-color:#10b981; /* Green */ }
    .status-saving  { background-color:#f59e0b; /* Amber */ animation:pulse 2s infinite; }
    .status-error   { background-color:#ef4444; /* Red */ }
    .status-offline { background-color:#6b7280; /* Gray */ }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

    .github-setup { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <a href="#content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white px-3 py-2 rounded-md shadow">Sari la conținut</a>

  <header class="bg-white shadow-sm no-print">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold">Fișă de Pontaj – Cramă</h1>
        <div id="statusContainer" class="flex items-center mt-1">
          <span id="statusIndicator" class="status-indicator status-offline"></span>
          <span id="statusText" class="text-sm text-gray-500">Configurează GitHub</span>
        </div>
      </div>
      <div class="text-sm text-gray-500">Versiunea 3.4</div>
    </div>
  </header>

  <main id="content" class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <div id="githubStatus" class="no-print mb-6 p-4 rounded-lg github-setup text-white shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-medium">Sincronizare GitHub</h3>
          <p class="text-sm opacity-90">Datele sunt sincronizate cu un repository GitHub.</p>
        </div>
        <button id="openGithubConfig" class="focusable bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-semibold">Configurează</button>
      </div>
    </div>

    <div id="githubModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden no-print">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 sm:p-8" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="flex justify-between items-center mb-4">
          <h2 id="modal-title" class="text-lg font-semibold">Configurare GitHub Storage</h2>
          <button id="closeGithubModal" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <div class="space-y-4">
          <div>
            <label for="githubToken" class="block text-sm font-medium text-gray-700">Token de acces personal</label>
            <input id="githubToken" type="password" class="focusable mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
            <p class="mt-1 text-xs text-gray-500">Necesită permisiuni de `repo` sau `contents:read/write`.</p>
          </div>
          <div>
            <label for="githubRepo" class="block text-sm font-medium text-gray-700">Repository (format: `utilizator/repo`)</label>
            <input id="githubRepo" type="text" class="focusable mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border" placeholder="ex: ion-popescu/pontaj-data" />
          </div>
          <div class="flex gap-2 pt-2">
            <button id="saveGithubConfig" class="focusable flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">Salvează și închide</button>
            <button id="testConnection" class="focusable flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 font-semibold">Testează conexiunea</button>
          </div>
          <div id="githubError" class="mt-2 text-sm text-red-600 hidden font-medium"></div>
        </div>
      </div>
    </div>

    <section class="no-print mb-4 grid grid-cols-2 sm:grid-cols-3 lg:flex gap-2">
      <button id="addRow" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Adaugă rând</button>
      <button id="deleteSelected" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Șterge selectatele</button>
      <button id="exportCSV" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Export CSV</button>
      <button id="printBtn" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800">Printează</button>
      <button id="resetData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600">Resetează date</button>
      <button id="syncData" type="button" class="focusable inline-flex items-center justify-center px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">Sincronizează</button>
    </section>

    <form id="timesheetForm" class="bg-white rounded-xl shadow-md ring-1 ring-gray-200 overflow-hidden">
      <div class="p-4 sm:p-6">
        <div class="max-w-sm">
          <label for="workerSelect" class="block text-sm font-medium text-gray-700">Angajat (Cramă)</label>
          <select id="workerSelect" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border">
            <option value="Prică Jenița">Prică Jenița</option>
            <option value="Neagu Marian">Neagu Marian</option>
            <option value="Banu Mitică">Banu Mitică</option>
            <option value="Prică Emilian">Prică Emilian</option>
            <option value="__custom">Alt nume…</option>
          </select>
          <input id="workerName" type="text" class="mt-2 hidden w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border" placeholder="Introdu numele" />
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-3 py-2 text-left font-semibold">✔</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Data</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Început</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Sfârșit</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Pauză (min)</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Activitate / Observații</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Ore</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="6" class="px-3 py-3 text-right font-semibold">Total general (ore):</td>
              <td class="px-3 py-3 text-right"><span id="grandTotal" class="font-bold">0.00</span></td>
            </tr>
          </tfoot>
        </table>
      </div>
       <div class="p-4 grid sm:grid-cols-2 gap-6 print-block hidden">
        <div>
          <p class="font-semibold">Întocmit de:</p>
          <div class="h-16 border-b"></div>
        </div>
        <div>
          <p class="font-semibold">Confirmat (Responsabil cramă):</p>
          <div class="h-16 border-b"></div>
        </div>
      </div>
    </form>
     <p class="mt-3 text-xs text-gray-500 no-print">Hint: Dacă o tură trece de miezul nopții, bifează „Zi următoare” pe rândul respectiv.</p>
  </main>

  <footer class="no-print border-t bg-white mt-8">
    <div class="max-w-5xl mx-auto px-4 py-3 text-xs text-gray-500">© <span id="year"></span> – Fișă de Pontaj Cramă</div>
  </footer>

  <template id="rowTemplate">
    <tr>
      <td class="px-3 py-2 align-top"><input type="checkbox" aria-label="Selectează rând" class="focusable w-4 h-4" /></td>
      <td class="px-3 py-2 align-top"><input type="date" class="focusable block w-40 rounded-md border-gray-300 px-2 py-1 border" /></td>
      <td class="px-3 py-2 align-top"><input type="time" step="60" class="focusable block w-28 rounded-md border-gray-300 px-2 py-1 border" /></td>
      <td class="px-3 py-2 align-top">
        <div class="flex items-center gap-2">
          <input type="time" step="60" class="focusable block w-28 rounded-md border-gray-300 px-2 py-1 border" />
          <label class="inline-flex items-center gap-1 text-xs text-gray-600 select-none">
            <input type="checkbox" class="next-day-toggle focusable">
            <span>Zi următoare</span>
          </label>
        </div>
      </td>
      <td class="px-3 py-2 align-top"><input type="number" min="0" step="5" value="0" class="focusable block w-24 rounded-md border-gray-300 px-2 py-1 border" /></td>
      <td class="px-3 py-2 align-top"><textarea rows="1" class="focusable block w-full rounded-md border-gray-300 px-2 py-1 border" placeholder="ex: cules, sortare..."></textarea></td>
      <td class="px-3 py-2 align-top text-right"><output class="rowTotal font-medium">0.00</output></td>
    </tr>
  </template>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- State, Helpers & Elements ---
      const WORKERS = ["Prică Jenița", "Neagu Marian", "Banu Mitică", "Prică Emilian"];
      const els = {
        tableBody: document.getElementById("tableBody"), rowTmpl: document.getElementById("rowTemplate"),
        grandTotal: document.getElementById("grandTotal"), addRow: document.getElementById("addRow"),
        deleteSelected: document.getElementById("deleteSelected"), exportCSV: document.getElementById("exportCSV"),
        printBtn: document.getElementById("printBtn"), resetData: document.getElementById("resetData"),
        syncData: document.getElementById("syncData"), workerSelect: document.getElementById("workerSelect"),
        workerName: document.getElementById("workerName"), githubModal: document.getElementById("githubModal"),
        openGithubConfig: document.getElementById("openGithubConfig"), closeGithubModal: document.getElementById("closeGithubModal"),
        githubToken: document.getElementById("githubToken"), githubRepo: document.getElementById("githubRepo"),
        saveGithubConfig: document.getElementById("saveGithubConfig"), testConnection: document.getElementById("testConnection"),
        statusIndicator: document.getElementById("statusIndicator"), statusText: document.getElementById("statusText"),
        githubError: document.getElementById("githubError"), year: document.getElementById("year"),
      };
      
      let githubConfig = { token: '', repo: '' };
      let saveTimeout = null;

      const slug = s => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      const currentWorker = () => els.workerSelect.value === "__custom" ? (els.workerName.value.trim() || "custom") : els.workerSelect.value;
      const getFileName = () => `data/pontaj_${slug(currentWorker())}.json`;
      const getLocalStorageKey = () => `pontaj-v3.4-local-${slug(currentWorker())}`;

      function updateStatus(status, msg) {
        els.statusIndicator.className = `status-indicator status-${status}`;
        els.statusText.textContent = msg;
        if (status === 'error') {
          showErrorInModal(msg);
        } else {
          hideErrorInModal();
        }
      }
      
      function showErrorInModal(msg) {
        els.githubError.textContent = msg;
        els.githubError.classList.remove("hidden");
      }

      function hideErrorInModal() {
        els.githubError.classList.add("hidden");
      }

      // --- GitHub API Communication ---
      async function githubRequest(endpoint, options = {}) {
        if (!githubConfig.token || !githubConfig.repo) throw new Error("GitHub nu este configurat.");
        const [owner, repo] = githubConfig.repo.split("/");
        if (!owner || !repo) throw new Error("Formatul repository-ului este invalid. Folosește `utilizator/repo`.");
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${endpoint}`;
        const resp = await fetch(url, {
          ...options,
          headers: { 'Authorization': `Bearer ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json', ...(options.headers || {}) },
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ message: `Eroare rețea: ${resp.statusText}` }));
          throw new Error(err.message || `Eroare HTTP ${resp.status}`);
        }
        return resp.json();
      }

      async function saveToGitHub(data) {
        if (!githubConfig.token || !githubConfig.repo) return; // Fail silently if not configured
        updateStatus("saving", "Salvează pe GitHub...");
        try {
          const path = getFileName();
          const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
          let sha;
          try {
            const existing = await githubRequest(path);
            sha = existing.sha;
          } catch (e) {
             // File doesn't exist, which is fine.
          }
          const payload = {
            message: `Update: ${currentWorker()} – ${new Date().toLocaleString("ro-RO")}`,
            content,
            ...(sha ? { sha } : {}),
          };
          await githubRequest(path, { method: "PUT", body: JSON.stringify(payload) });
          updateStatus("saved", `Sincronizat la ${new Date().toLocaleTimeString()}`);
        } catch (e) {
          updateStatus("error", `Eroare GitHub: ${e.message}`);
        }
      }

      async function loadFromGitHub() {
        if (!githubConfig.token || !githubConfig.repo) return null;
        updateStatus("saving", "Încarcă de pe GitHub...");
        try {
          const data = await githubRequest(getFileName());
          const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
          updateStatus("saved", "Date încărcate de pe GitHub");
          return content;
        } catch (e) {
          if (e.message.includes("Not Found")) {
             updateStatus("saved", "Fișier nou. Salvează pentru a-l crea.");
          } else {
             updateStatus("error", `Eroare la încărcare: ${e.message}`);
          }
          return null; // Return null to indicate we should use local data
        }
      }
      
      // --- Core Application Logic ---
      const computeDuration = (start, end, breakMin, isNextDay) => {
        if (!start || !end) return 0;
        const [sh, sm] = start.split(":").map(Number);
        const [eh, em] = end.split(":").map(Number);
        let startMins = sh * 60 + sm;
        let endMins = eh * 60 + em;
        if (isNextDay || endMins < startMins) endMins += 24 * 60;
        return Math.max(0, endMins - startMins - (parseInt(breakMin, 10) || 0)) / 60;
      };

      const computeGrand = () => {
        let total = 0;
        els.tableBody.querySelectorAll("tr").forEach(tr => total += parseFloat(tr.querySelector("output.rowTotal").textContent || 0));
        els.grandTotal.textContent = total.toFixed(2);
      };

      const getTableData = () => {
        const rows = [];
        els.tableBody.querySelectorAll("tr").forEach(tr => {
          const [chk, date, start, end, breakMin, notes, out] = tr.querySelectorAll("input, textarea, output");
          const nextDay = tr.querySelector("input.next-day-toggle");
          rows.push({
            date: date.value || "", start: start.value || "", end: end.value || "",
            nextDay: !!(nextDay && nextDay.checked), breakMin: parseInt(breakMin.value || 0, 10),
            notes: notes.value || "",
          });
        });
        return {
          meta: { worker: currentWorker(), lastUpdated: new Date().toISOString(), version: "3.4" },
          rows,
        };
      };

      function save() {
        const data = getTableData();
        // Save to local storage as a backup/for offline use
        localStorage.setItem(getLocalStorageKey(), JSON.stringify(data));
        // Save to GitHub
        saveToGitHub(data);
      }
      
      const debouncedSave = () => {
        clearTimeout(saveTimeout);
        updateStatus("saving", "Așteaptă...");
        saveTimeout = setTimeout(save, 1000);
      };

      async function load() {
        els.tableBody.innerHTML = "";
        let data = await loadFromGitHub(); // Try GitHub first
        if (!data) { // If GitHub fails or is empty, try local storage
          const localRaw = localStorage.getItem(getLocalStorageKey());
          try {
            data = localRaw ? JSON.parse(localRaw) : null;
            if(data) updateStatus("offline", "Date locale. Conectează-te pentru a sincroniza.");
          } catch { data = null; }
        }
        
        const list = (data && data.rows && data.rows.length) ? data.rows : [{}];
        list.forEach(r => addRowUI(r));
        computeGrand();
        // Save locally after loading from GitHub to create a backup
        if(data) localStorage.setItem(getLocalStorageKey(), JSON.stringify(data));
      }

      // --- UI Functions ---
      function addRowUI(data) {
        const node = els.rowTmpl.content.cloneNode(true);
        const [chk, date, start, end, breakMin, notes, out] = node.querySelectorAll("input, textarea, output");
        const nextDay = node.querySelector("input.next-day-toggle");

        if (data) {
          date.value = data.date || ""; start.value = data.start || ""; end.value = data.end || "";
          breakMin.value = data.breakMin ?? 0; notes.value = data.notes || "";
          if (nextDay && typeof data.nextDay === "boolean") nextDay.checked = data.nextDay;
        }

        const recalc = () => {
          const dur = computeDuration(start.value, end.value, breakMin.value, nextDay && nextDay.checked);
          out.textContent = dur.toFixed(2);
          computeGrand();
          debouncedSave();
        };

        [date, start, end, breakMin, notes, nextDay].forEach(el => el && el.addEventListener("input", recalc));
        recalc();
        els.tableBody.appendChild(node);
      }
      
      const deleteSelectedRows = () => {
        const toDelete = Array.from(els.tableBody.querySelectorAll("tr")).filter(tr => tr.querySelector('input[type="checkbox"]').checked);
        if (!toDelete.length) return;
        if (!confirm(`Sigur dorești să ștergi ${toDelete.length} rând(uri)?`)) return;
        toDelete.forEach(tr => tr.remove());
        if (!els.tableBody.querySelector("tr")) addRowUI({});
        computeGrand();
        save();
      };
      
      // --- Event Listeners & Init ---
      function setupEventListeners() {
        els.addRow.addEventListener("click", () => { addRowUI({}); save(); });
        els.deleteSelected.addEventListener("click", deleteSelectedRows);
        els.printBtn.addEventListener("click", () => window.print());
        els.syncData.addEventListener("click", load);
        
        els.resetData.addEventListener("click", () => {
          if (!confirm(`Atenție! Aceasta va șterge TOATE datele pentru ${currentWorker()} din browser și de pe GitHub. Continui?`)) return;
          localStorage.removeItem(getLocalStorageKey());
          els.tableBody.innerHTML = "";
          addRowUI({});
          save(); // This will save an empty state to GitHub
        });

        // Worker selection
        els.workerSelect.addEventListener("change", () => {
          if (els.workerSelect.value === "__custom") {
            els.workerName.classList.remove("hidden");
            els.workerName.focus();
          } else {
            els.workerName.classList.add("hidden");
            els.workerName.value = "";
          }
          load();
        });
        els.workerName.addEventListener("input", load);

        // GitHub Modal
        els.openGithubConfig.addEventListener("click", () => els.githubModal.classList.remove("hidden"));
        els.closeGithubModal.addEventListener("click", () => els.githubModal.classList.add("hidden"));
        els.saveGithubConfig.addEventListener("click", () => {
          githubConfig.token = els.githubToken.value;
          githubConfig.repo = els.githubRepo.value;
          localStorage.setItem('pontaj-github-config', JSON.stringify(githubConfig));
          els.githubModal.classList.add("hidden");
          testGitHubConnection(); // Test and then load
        });
        els.testConnection.addEventListener("click", testGitHubConnection);

        els.exportCSV.addEventListener("click", () => { /* Add export logic here if needed */ });
      }

      async function testGitHubConnection() {
        githubConfig.token = els.githubToken.value;
        githubConfig.repo = els.githubRepo.value;
        updateStatus("saving", "Testare...");
        try {
          const [owner, repo] = githubConfig.repo.split("/");
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}`, { headers: { Authorization: `Bearer ${githubConfig.token}` } });
          if (resp.ok) {
            updateStatus("saved", `Conectat la ${owner}/${repo}`);
            hideErrorInModal();
            load();
            return true;
          }
          const err = await resp.json();
          throw new Error(err.message || `HTTP ${resp.status}`);
        } catch (e) {
          updateStatus("error", e.message);
          return false;
        }
      }
      
      // Initializer function
      function init() {
        els.year.textContent = new Date().getFullYear();
        
        // Load GitHub config from local storage
        const savedConfig = localStorage.getItem('pontaj-github-config');
        if (savedConfig) {
          githubConfig = JSON.parse(savedConfig);
          els.githubToken.value = githubConfig.token;
          els.githubRepo.value = githubConfig.repo;
        }

        // Setup UI and load data
        els.workerSelect.value = WORKERS[0];
        setupEventListeners();
        
        if (githubConfig.token && githubConfig.repo) {
            testGitHubConnection();
        } else {
            updateStatus("offline", "Configurează GitHub pentru a sincroniza.");
        }
      }

      init();
    });
  </script>
</body>
</html>
